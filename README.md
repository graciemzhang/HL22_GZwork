# HL22_GZwork
Hengen Lab scripts and files concerning video analysis and behavior identification.

**annotation_cleaning**: Contains all scripts and files concerning the processing of any behavior annotations.
>***consolidating_annotations_df.ipynb***

Puts all behavioral annotations into the optical flow dataframe. Built off of the work done in ***resolution_annotations***.

>***resolution_annotations.ipynb***

Creates the steps used in ***consolidating_annotations_df.ipynb***, but not accurate to current process of cleaning annotations.

> _annotations_df-feather_: feather format

Optical flow dataframe with loc_behavior and reg_behavior columns generated through the ***consolidating_annotations_df.ipynb*** notebook, which includes the key for all encoded behaviors. NaN values indicate no behavior. Should a video only have NaN values, this indicates that this video was not annotated. Annotatations align by frame to the video that was annotated. 

> **intervals**: Contains all csv files related to annotation intervals, should also be located in Google Drive
- _CAF99_WinN.csv_: All annotations for CAF99 when experiencing Wake in NREM flickers. Used in _ notebook.
- _CAF106_NtoW.csv_: All annotations for CAF106 when experiencing NREM to Wake flickers. Used in _ notebook.
- _out_of_frame - CAF106_org.csv_: All intervals in which CAF106 is out of frame. Used in _ notebook.

**video_analysis**: Contains all scripts and files relating to video libraries, such as PIL and cv2. 
> ***color_filtering.ipynb***

Experiments with isolating objects by applying a color filter. The issue with color isolation was selecting an accurate and precise color range. Without being able to do so, the filter selected more than the desired object. 

>**flicker_clipper**

Contains Doran's script ***video_clipper.ipynb***. Includes the font file. Clips flicker intervals given the type of flicker and video input. 

>**behavior_clipper**

Contains ***clip_behavior_vids.ipynb***, which uses the annotations to clip intervals of each behavior. The script also extracts a certain number of generated clips randomly clips and puts them into test folders, which are included in this directory.

**annotation_analysis**: Contains all scripts and files concerning the prediction of movement from the optical flow.
> **files**: Contains basic utilities that are necessary to perform the predictive annotations. 
- ***functions.ipynb*** contains all functions needed for processing. A median filter is applied to the percentile normalized flow, and a new column of short band values is generated. From there, predictions can be made to the mouse's movement. Should the short band be TRUE, it can be assumed that the mouse is either twitching or adjusting posture. In order to verify these predictions, several functions are generated to isolate the flicker intervals and compare them to the videos using timestamps. 

An issue that arose was the presence of another mouse in the frame of the video. This interfered with the calculations of optical flow as the other mouse's movements was also taken into account. These predictive annotations are unable to be used until optical flow is recalculated. 

- ***utilities.ipynb*** runs all the functions from ***functions.ipynb*** in order to generate the necessary files. These files are pickled for easy and efficient access. Once this notebook is run once, there is no need to run it again. 

> **predictive_annotations**: Contains scripts that analyze accuracy and ability.
- ***traces_application.ipynb*** graphs the normalized optical flow against the traces. This script is practical in showing whether or not the predictions are feasible. It makes use of all the files generated by the ***utilities.ipynb*** notebook.

- ***annotation_prediction.ipynb*** is an unpolished version of ***utilities.ipynb*** and is made redundant.

- ***optical_flow_recalculation.ipynb*** tests whether or not my local computer can handle the computational challenge of recalculating the optical flow. It can not. 

- ***behavior_stripplot.ipynb*** plots all behaviors against their duration.

>**WN**: Contains all exploratory scripts which lead to the finalized process in ***utilities.ipynb***.
- ***Analyzing Flicker Annotations + Optical Flow.ipynb*** is the first notebook written to determine the relationship between the normalized optical flow and the flicker annotations. This script is purely exploratory and not necessary when doing predictive annotations. Does contain sensitivity and specificity measures used when creating the rule for prediction. 

- ***CAF106_flicker_analysis.ipynb*** is similar to the previous notebook. This script follows the same framework but is dedicated solely to CAF106. It also takes into account any out of frame intervals.

>**RW**: Contains analysis for REM in WAKE flickers to determine whether there is a useful relationship between behavior and optical flow. 
- ***rw_analysis.ipynb*** processes the annotations for REM in WAKE flickers. This script finds the intervals of RW flickers and plots the optical flow for exploratory purposes. 

**classification**: Contains all scripts and files involved in generating the dataframe required for classification.
>**annotations**: Contains all test annotations as csv, including their regular and location-constrained separated behavior arrays, which are pickled. 

The annotations are read in and processed using the same steps as demonstrated in ***consolidating_annotations_df.ipynb***.

>**behavior_propagate**: Contains object prediction files. Parent directories must all be in the same format. Mouse name should be lowercase, and there should be an underscore with "infer" after. Each directory contains processed .txt files. There is a .txt file for each frame of the video containing the predicted x and y coordinates of each object.
-**caf26_infer**
-**caf42_infer**
-**caf99_infer**
-**kdr48_infer**

>**dlc**: Contains body parts prediction files. 

>**files**: Contains pickled dictionaries that store the prediction files. More information under ***preprocess_save_files.ipynb***. 

- Additionally stores the generated features dataframe, which is named "features_df" and is a pickled file. 

>***post_processing_dlc.ipynb*** plots likelihood against delta x for each body part. 

>***preprocess_save_files.ipynb*** takes all files needed to generate the classification dataframe and pickles them for more efficient access. 
- For the object prediction files, each .txt file is read in as a dataframe. All dataframes are concated together to yield a multiindex dataframe. Every multiindex dataframe is flattened, then added to a dictionary as the value, with the key being the mouse's name. This dictionary is needed for further analysis. The dictionary is named "all_obj_dict". The flattened dictionary is named "flatten_all_obj_dict". Each individual dataframe is named as "mouse_obj_df". Each flattened dataframe is named as "flatten_mouse_obj_df". Only the flattened dictionary is used. 

- For the body parts prediction files, the .h5 file is read in as a dataframe. Each dataframe is stored in a dictionary as the value, with the key being the mouse's name. The individual dataframe is stored as an .h5 file named as "mouse_dlc_df.h5". The dictionary is named as "all_parts_dict". Only the dictionary is used. 

>***analysis_of_object_and_body_part_detection*** generates all features from object and body parts prediction files. Steps outlined in the notebook. 















